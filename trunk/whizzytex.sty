%  WhizzyTeX - a wysiwyg environment for TeX
%  Copyright (C) 2002 Didier Rémy
% 
%  This library is free software; you can redistribute it and/or
%  modify it under the terms of the GNU Lesser General Public
%  License as published by the Free Software Foundation; either
%  version 2 of the License, or (at your option) any later version.
% 
%  This library is distributed in the hope that it will be useful,
%  but WITHOUT ANY WARRANTY; without even the implied warranty of
%  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
% 
%  See the GNU Lesser General Public License version 2.1 for more
%  details (enclosed in the file LGPL).
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  File whizztex.sty (TeX and LaTeX macros)
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\nonstopmode
\let \scrollmode \relax
\newif \if@whizzysafe  \@whizzysafefalse
\def \whizzy@A {\def \whizzy@do{\catcode `\^^A 2\WhizzyMarkBegin}\ifinner
\ifmmode \else\def \whizzy@do{}\fi \fi \whizzy@do}
\begingroup
\catcode `\^^A \active
\gdef \whizzy@@active {\def ^^A{\whizzy@A}}
\global \def ^^A{\whizzy@A}
\catcode `\[ 1 \catcode `\] 2
\catcode `\{ 12 \catcode `\} 12
\catcode `| 0 \catcode`\\ 12
|global |long |def |dump@skip #1\begin{document}[|dump@resume]
|endgroup
\def \dump@restart {\begingroup \let \do \@makeother \dospecials \dump@skip}

\def \dump@resume
  {\endgroup 
   \@whizzy@fulldocument
   \message {[WisyTeX is resuming in LaTeX mode]}
   \whizzy@wizfalse \relax
   \let \documentclass \@documentclass
   \begin{document}}

\def \whizzy@begindocumenthook {}
\def \WhizzyAtBeginDocument {\g@addto@macro \whizzy@begindocumenthook}
\let \latex@document \document
\def \whizzy@document
   {\whizzy@begindocumenthook \latex@document}
\let \@whizzy@fulldocument \relax
\def \whizzy@ignore #1{}
\def \whizzy@@overlay #1{\ifnum #1>\whizzy@layer \whizzy@overlay {1}\fi}
\def \whizzy@newl@bel #1#2#3{\global \@namedef {#1@#2}{#3}}
\def \whizzy@loadaux 
 {\begingroup
    \@floatplacement \@dblfloatplacement \makeatletter \let \@writefile
     \@gobbletwo \global \let \@multiplelabels \relax 
     \@input {\jobname .aux}%
     \global \let \whizzy@multiplelabels \@multiplelabels
     \global \let \@newl@bel \whizzy@newl@bel
     \AtBeginDocument {\global \let  \@multiplelabels \whizzy@multiplelabels}%
  \endgroup
  }

\def \whizzy@advi 
   {\ifWhizzyAdvi \whizzy@par \else \let \whizzy@writelineno \relax \fi}
\def \document 
  {\endgroup
   \@ifundefined {Whizzysafe}
      {\usepackage{color}}
      {\@whizzysafetrue}%
   \AtBeginDocument {\whizzy@@active \whizzy@advi}%
   \IfFileExists{whizzy.sty}{\usepackage{whizzy}}{}%
   \begingroup \def \@currenvir {document}%
   \whizzy@loadaux
   \endgroup
   \@ifundefined {overlay}{}%{\let \@whizzy@fulldocument \relax}
      {\let \whizzy@overlay \overlay
       \let \overlay \whizzy@ignore
       \def \whizzy@fulldocument {\let \overlay \whizzy@overlay}}%
   \g@addto@macro \@begindvi
       {\g@addto@macro \@begindvi {\whizzy@writelastpage}}%
%    \@ifundefined {AtEndPage}
%      {\def \endpage@hook {\whizzy@writelastline}
%       \g@addto@macro \@begindvi 
%          {\endpage@hook \g@addto@macro \@begindvi {\endpage@hook}}}
%      {\AtEndPage {\whizzy@writelineno}}
% comment if necessary
   \let \@iinput \whizzy@iinput
   \let \@input@ \whizzy@input@
   \let \@documentclass \documentclass
   \let \documentclass \dump@restart
%   \AtBeginDocument {\whizzy@begindocumenthook}%
   \let \document \latex@document
   \dump}

%%% Macros for dumping sections in \@whizzy  (\jobname.pag)

\def \whizzy@markon #1#2{%
  \expandafter \let \expandafter \@do \csname #1\endcsname
  \expandafter \let \csname whizzy@#1\endcsname \@do
  \def \@do {\whizzy@mark {#2}\csname whizzy@#1\endcsname}%
  \expandafter \let \csname #1\endcsname \@do
}
\def \whizzy@markafter #1#2{%
  \expandafter \let \expandafter \@do \csname #1\endcsname
  \expandafter \let \csname whizzy@#1\endcsname \@do
  \def \@do {\csname whizzy@#1\endcsname\whizzy@mark {#2}}%
  \expandafter \let \csname #1\endcsname \@do
}
\def \whizzy@putmarks {%
  \@ifundefined{c@chapter}{}{\whizzy@markon {chapter}{chapter}}%
  \whizzy@markon {section}{section}%
  \whizzy@markon {subsection}{subsection}%
  \whizzy@markon {subsubsection}{subsubsection}%
  %\whizzy@markafter {@outputpage}{page}%
}
\def \whizzy@mark #1{\immediate \write \@whizzy
  {\whizzy@curfile.tex:\the\inputlineno:#1@\thepage.%
  \@ifundefined{c@chapter}{}{\the\c@chapter.}%
  \the\c@section.\the\c@subsection.}%
}

\edef\whizzy@quote{\string"}

%%% Macros for dumping lines number, putting cursor, etc. 

% \jobname should be the current file, instead. It is stored somewhere?
\def \whizzy@writelineno
   {\ifhmode \unskip \fi
    \xdef \whizzy@lastparno {\the\inputlineno}%
    \special {line: \the\inputlineno \space \whizzy@curfile}}
\def \whizzy@pageno {0}
\def \whizzy@lastpageno {0}
\def \whizzy@writelastpage
  {\special {line: \whizzy@lastpageno \space \whizzy@curfile}%
   \xdef \whizzy@lastpageno {\whizzy@pageno}%
   \xdef \whizzy@pageno {\the \inputlineno}%
}
% \def \whizzy@writeline@page
%    \xdef \whizzy@lastlineno {\the\inputlineno}%

\def \whizzy@lineno@display 
   {\whizzy@writelineno \aftergroup \whizzy@writelineno}
% To insert the mark ``around'' the current line number
\def \whizzy@starthere
   {%\ifhmode \unskip \fi
    \special {html:<A name=\whizzy@quote Start-Document\whizzy@quote>}%
    \special {html:</A>}%
    %\ifhmode \hskip \lastskip \fi
    \message {[Start-Document @ \whizzy@line -> \the\inputlineno\space
               \whizzy@curfile]}%
    \global \let \whizzy@checkline \relax
    \global \let \whizzy@@checkline \relax
    \global \let \whizzy@check@line \relax
    \global \let \begin \whizzy@begin
    \global \let \whizzy@starthere \relax
    }
\let \latex@@par \@@par
\let \whizzy@checkline \relax
\def \whizzy@@par 
  {\whizzy@checkline \whizzy@writelineno \latex@@par}
\let \whizzy@catcode \relax
\def \whizzy@@check@limit 
  {\ifnum \inputlineno>\whizzy@line \whizzy@starthere \fi}
\def \whizzy@@checkline {%
   \ifx \whizzy@curfile \whizzy@local
      \ifnum \inputlineno>\whizzy@linelimit
         \ifnum \inputlineno>\whizzy@line \whizzy@starthere 
         \else 
            \let \whizzy@checkline \whizzy@@check@limit
            \global \let \whizzy@@checkline \whizzy@@check@limit
            \edef \@tmp {\noexpand \whizzy@check@line  \the\everymath}%
            \expandafter \everymath \expandafter {\@tmp}%
         \fi
      \fi
   \fi
}
\let \whizzy@begin \begin
\def \whizzy@@begin {\whizzy@checkline \whizzy@begin}
\def \whizzy@check@line {\whizzy@checkline \aftergroup\whizzy@checkline}
%% In display mode, to still ignorespaces after display. 
%% hence \aftergroup \ignorespaces. Hoever, spaces would still ignored when
%% the display ends with \eqno or \lqeno.  
\let \latex@eqno \eqno
\let \latex@leqno \leqno
\def \aftergroup@ignorespaces  {\aftergroup \ignorespaces}
\def \whizzy@eqno {\expandafter \latex@eqno \aftergroup@ignorespaces}
\def \whizzy@leqno {\expandafter \latex@leqno \aftergroup@ignorespaces}
\def \whizzy@check@line@ {\whizzy@checkline
 \aftergroup\whizzy@checkline \aftergroup\ignorespaces
 \let \leqno \whizzy@leqno \let \eqno \whizzy@eqno}
%%
\def \whizzy@line{}
\def \whizzy@nopar {\let \@@par \latex@@par \let \par \@@par}
\def \WhizzySkip {\ifWhizzyAdvi \whizzy@nopar\fi}
\def \WhizzyStart {\ifWhizzyAdvi \whizzy@par \whizzy@writelineno \fi}
\def \whizzy@fill 
  {\leavevmode \leaders \hrule height 0.15em \hfill \kern \z@}
\def \whizzy@master@banner
  {{\LARGE\bf \whizzy@fill\space
    File mastered by \whizzy@master{} \whizzy@fill}}
\def \whizzy@outputline #1#2{\ifWhizzyAdvi\special {line: #1 #2 }\fi}
\def \whizzy@outputmaster {%
  \noindent
  \whizzy@outputline {0}{\whizzy@master}%
  \whizzy@master@banner
  \whizzy@outputline {0}{\whizzy@master}%
}
\def \whizzy@master@end{%
  \par \bigskip
  \whizzy@setfile {\whizzy@master}
  \whizzy@setfile {\whizzy@master}\whizzy@outputmaster
  \whizzy@setfile {\whizzy@local}%
\par
}

\def \WhizzyMaster #1#2{%
  \def \whizzy@master {#1}\def \whizzy@local {#2}%
  \special {line: 0 #1 }%
  \par\noindent \whizzy@master@banner \par\bigskip
  \whizzy@setfile {#2}%  
  \special {line: 0 #1 }\special {line: 0 #2 }%
  \AtEndDocument {\whizzy@master@end}\WhizzyTeX@file}
\def \whizzy@par {\let \@@par \whizzy@@par \let \par \@@par}
\def \WhizzyLine #1{%
  \def \whizzy@line{#1}%
  \bgroup \count0 #1\advance\count0 by -20
  \global \edef \whizzy@linelimit {\the \count0}\egroup%
  \let \whizzy@checkline \whizzy@@checkline
  \whizzy@par
  \everydisplay{\whizzy@lineno@display \let \halign \whizzy@halign
                \whizzy@check@line@}%
  \let \begin \whizzy@@begin%
}

%%% Hack because \whizzy@lineno@display generates $$\hbox{}\halign
%%% which is not correct. The \hbox cannot be removed.
%%% The other option is to remove lineno at beginning of display
%%% might be better.

\let \latex@halign \halign
\def \whizzy@endhalign {\egroup $$}
\def \whizzy@halign {\ifmmode 
 \vcenter \bgroup \everydisplay{}\let \halign \latex@halign 
  \abovedisplayskip 0em $$\aftergroup  \whizzy@endhalign \else
  \latex@halign \fi} 

\def \WhizzytexInput #1{
\message {[WhizzyTeX is dumping positions in _whizzy_#1.pag]}
\newwrite \@whizzy 
\immediate \openout \@whizzy _whizzy_#1.pag
\whizzy@putmarks
\latex@iinput {#1.tex}%
}

\newif \ifwhizzy@wiz \whizzy@wiztrue
\AtBeginDocument 
 {\ifwhizzy@wiz \@input {\jobname .wiz}\fi 
  \newwrite \@wizout \immediate \openout \@wizout \jobname.wiz
  \def \@wiz #1{\immediate \write \@wizout {#1}}%
 }

\global \@specialpagefalse
\def \WhizzyTeX #1.#2.#3.{%
   \setcounter{page}{#1}%
   \setcounter{section}{#2}\setcounter{subsection}{#3}}
\def \WhizzyTeX@chapter #1.#2.#3.#4.{%
   \setcounter{page}{#1}\setcounter{chapter}{#2}%
   \setcounter{section}{#3}\setcounter{subsection}{#4}}
\def \WhizzyTeX@file {%
   \@ifundefined {whizzy@\whizzy@local @}{}
     {\edef \@do {\csname whizzy@\whizzy@local @\endcsname}%
      \expandafter \WhizzyTeX \@do\relax}}
\@ifundefined {c@chapter}{}{\let \WhizzyTeX \WhizzyTeX@chapter}

\newcommand {\WhizzyTeXslide}[2][]
   {\let \overlay \whizzy@@overlay
    \whizzy@line{#2}\def \whizzy@layer{#1}}

\def \WhizzyMarkBegin
  {\ifmmode \setbox0 \hbox \bgroup \aftergroup \WhizzyMarkEnd \ensuremath 
   \else \setbox0 \hbox \bgroup \aftergroup \WhizzyMarkEnd \fi
   \catcode `\ 2}
   
\def \WhizzyMarkEnd 
   {\bgroup
      \@ifundefined {colorbox}
           {\def \@do {\fbox}}
           {\def \@do {\colorbox{yellow}}}%
       \setbox1 \hbox
           {\@do {\hskip -\fboxsep\strut \copy0\hskip -\fboxsep}}\wd1 \wd0
           \dp1 0em \ht1 0em \box1
    \egroup
   } 

\def \WhizzyMarkBegin 
  {\whizzy@starthere
   \ifmmode \rlap {\setbox0 \hbox {\strut \space}\WhizzyMarkEnd}\else
   \ifhmode \rlap {\setbox0 \hbox {\strut \space}\WhizzyMarkEnd}\else 
      \ifvmode
%         \bgroup 
%              \setbox0 \hbox {\strut\space}\WhizzyMarkEnd%
%             \wd0 0em\dp0 0em\box0\vskip -2\ht0\vskip -2\dp0% -\baselineskip
%         \egroup
        \vskip -\baselineskip 
        \hbox {\vbox to 0em{\vskip 1em
               \setbox0 \hbox {\strut\space}\box1\WhizzyMarkEnd \vss}}%
      \fi
   \fi \fi
  }

\AtBeginDocument {\catcode `\ \active}

\newif \ifWhizzyAdvi \WhizzyAdvifalse
\def \@Meaning #1{\string #1=\meaning #1\egroup}
\newcommand{\Meaning}
  {\par  \medskip \hrule \smallskip \vbox \bgroup
       \tt \hsize 0.7\hsize\makeatletter \@Meaning}

%% experimental

\let \latex@iinput \@iinput
\let \latex@input@ \@input@

\def \whizzy@tex {tex}
\def \whizzy@setfile #1{\xdef \whizzy@curfile {#1}}
\def \whizzy@setnorm #1{%
  \begingroup 
     \filename@parse {#1}%
     \xdef \whizzy@curfile
       {\filename@area\filename@base
        \@ifundefined {filename@ext}{}
           {\ifx \filename@ext \whizzy@tex \else .\filename@ext\fi}}%
  \endgroup
}
% We could interprepret the absence of file name as the master file name
\whizzy@setfile {\jobname}
\def \whizzy@iinput 
   {\expandafter \whizzy@input \expandafter{\whizzy@curfile}{\latex@iinput}}
\def \whizzy@input@
   {\expandafter \whizzy@input \expandafter{\whizzy@curfile}{\latex@input@}}
\def \whizzy@input #1#2#3{%
   \IfFileExists{#3}
      {\whizzy@setnorm{#3}%
       \immediate \write \@mainaux 
           {\string \gdef \string \whizzy @\whizzy@curfile @%
               {\thepage.\@ifundefined{c@chapter}{}{\the\c@chapter.}%
                \the\c@section.\the\c@subsection.}}%
           % could be removed if unsafe
          \whizzy@outputline {1}{\whizzy@curfile}%
      }{}%
    #2{#3}%
    \whizzy@setfile {#1}%
    \whizzy@writelineno
}
%% comment  \let \@iinput \whizzy@iinput above to cancel

\endinput

