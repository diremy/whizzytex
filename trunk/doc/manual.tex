%; whizzy   document -advi "advi -html Start-Document"

% The previous three lines are possible configuration for whizzytex. 
% They may not be there, then, the default will be used. 
% If not present the Time-stamp line will be added if necessary. 

\documentclass{article}

\topmargin 0em
\headsep 0in
\headheight 0in
\evensidemargin 0em
\oddsidemargin 0em

\usepackage {color}
\usepackage {hyperref}

\let \lst \verb

\def \whizzy {{Whizzy\kern -0.3ex\raise 0.2ex\hbox{\let \@\relax\TeX}}}
\def \Whizzy{\textbf {\textcolor {blue}{\whizzy}}}
\def \instruction #1{\par\medskip \noindent$\Rightarrow$ {\em #1}}
\def \version {\input {VERSION}}

%% The following lines are to help HeVeA make  the HTML version of the manual

%HEVEA \def \instruction #1{}
%HEVEA\def \whizzy{{Whizzy{\TeX}}}
%HEVEA\renewcommand{\@bodyargs}{TEXT=black BGCOLOR=white}

\begin{document}
\pagestyle {empty}

\author {Didier R{\'e}my}
\date {Version {\version} of \today}
\title {
{\huge \Whizzy\footnote{Whizzytex is free software, 
Copyright \copyright 2001, 2002 INRIA
and distributed under the GNU General Public License
(See the COPYING file enclosed with the distribution).}}
\\[1em]
{\em An {\bfseries Emacs} minor-mode \\
for {\bfseries incremental previewing of} \\ 
{\bfseries {\LaTeX} documents}}
}

\maketitle   


\begin{abstract}
\def \B{\textbf}
{\whizzy}\footnote {Standing for {\em {\B W}hat {\B i} {\B z}ee
{\B i}z what {\B y}ou {\expandafter \B \TeX}}} is an emacs minor mode for
incrementally ({\TeX}ing and) previewing 
a {\LaTeX} file that you are editing.
%
It works with ghostview-based and xdvi-based previewers, but best 
visual effect and more options will be available if you use  the
\href{http://pauillac.inria.fr/advi/}{Active-DVI} previewer. 

\end{abstract}

\section {Installation}

To use whizzytex, you need {\tt emacs} or {\tt xemacs}, {\tt latex2e}, and
{\tt bash} installed, and of course, some Postscript or DVI previewer.

{\whizzy} has been developed under Linux Redhat 7.2 but has not been
extensively tested on other platforms. While {\LaTeX} and Emacs are quite
portable, you may run into compatibility problem with the bash
shell-script. 


Get the source 
{\tt whizzytex-\version.tgz} 
from the \href{http://pauillac.inria.fr/whizzytex}{distribution}, 
uncompress and untar it in some working directory, as follows:
\begin{quote}
\begin{verbatim}
gunzip whizzytex-1.0.tgz
tar -xvf whizztex-1.0.tar
cd whizzytex 
\end{verbatim}
\end{quote}
Then, the installation can be automatic, or manual.

\subsection {Automatic installation}

By default, libraries will be installed in
\lst"/usr/local/lib/whizzytex/", or if nonexistent in
\lst"/usr/lib/whizzytex", and in some  Emacs site-lisp library 
according yo your emacs configuration. Run the command:
\begin{quote}
\begin{verbatim}
./configure
\end{verbatim}
\end{quote}
to produce \lst"Makefile.config", which you can edit and modify. 
(If you are upgrading a previous version, 
and you have modified this file, you probably do not wish to run 
{\tt configure} again.)

Then, to prepared configured version and install files in their respective
directories, type: 
\begin{quote}
\begin{verbatim}
make all
make install
\end{verbatim}
\end{quote}

\subsection {Manual installation}

Since {\whizzy} only need three files installed, these can also be installed
by hand:
\begin {itemize}

\item[]\hspace{-2em}{\tt whizzytex.el}

This should be installed in a directory visible by emacs, so that it can be
auto-loaded, or loaded by hand.

No default location.

\item[]\hspace {-2em}{\tt whizzytex}

This is a bash-shell script that should be executable.  There is not reason
to have it visible from the executable path, since it should not be used but
with {\whizzy}.

The variable {\tt whizzytex-command-name} defined in {\tt whizzytex.el} 
contains its full path (or just its name if visible from the executable
path). 

Default value is \lst"/usr/local/lib/whizzytex/whizzytex"

\item[]\hspace{-2em}{\tt whizzytex.sty}

This is a {\tt latex2e} macros package. 
There is no reason to put this visible from {\LaTeX} path, since it should
not be used but with {\whizzy}.

Variable variable {\tt PACKAGE} defined in {\tt whizzytex} 
the full path (or just the name if the path is visible from {\LaTeX}. 

Default value is \lst"/usr/local/lib/whizzytex/whizzytex.sty"

\end {itemize}

\subsection {Automatic upgrading}

For convenience, the distribution also offers a facility to download
and upgrade to new versions (this requires \lst"wget" installed).

\paragraph {Setup}
To benefit from this service you must first create, once for all, the
following link in the top directory of the distribution (where you untar the
original file).
\begin{quote}
\begin{verbatim}
cd ..
make -f whizzytex/Makefile.pkg Makefile
\end{verbatim}
\end{quote}
This create a \lst"Makefile" in this directory that includes
\lst"whizzytex/Makefile.pkg", which you may later edit if you wish to override
default settings.

\paragraph {Upgrading}
From the top directory of the distribution (where you did the setup), type 
\begin{quote}
\begin{verbatim}
make upgrade 
make install 
\end{verbatim}
\end{quote}
(You may wish to change the rights before you run \lst"make install"). 

The first command is in fact an abbreviation for
\begin{quote}
\begin{verbatim}
make update unpack build
\end{verbatim}
\end{quote}
which you can also run step-by-step to respectively
check for newer version and download if necessary, unpack
the current version if newer, and build the current version.

Other available commands are:
\begin{quote}
\begin{verbatim}
make VERSION=xxx donwload
make VERSION=xxx version
make clean
\end{verbatim}
\end{quote}
to download and unpack a specific version.

Upgrading may prompt the user for confirmation, but you can
pas the option \lst"FORCE=true" to the \lst"make" command and have
a fully automated installation. Hopefully, reasonable choices 
will be made in your place.


\section {Using {\whizzy}} 

\subsection {Quick start} 

You should first load the library \lst"whizzytex.el" or, better, make 
it autoload by including the following declaration 
in your Emacs startup file (probably  is \lst"~/.emacs"). 
\begin{quote}
\begin{verbatim}
(autoload 'whizzytex-mode "whizzytex" 
    "WhizzyTeX, a minor-mode WYSIWIG environment for LaTeX" t)
\end{verbatim}
\end{quote}
{\whizzy} runs as a minor mode of emacs to be launched on a {\LaTeX}
emacs buffer. To start it, type:
\begin{quote}
\begin{verbatim}
ESC x whizzytex-mode
\end{verbatim}
\end{quote}
By default, this should add new bindings so that you can later turn mode
on and off with key strokes {\tt C-c C-w}. This will also add a new menu
{\tt Whizzy} in the menu bar call ``the'' menu below.

When {\tt whizzytex-mode} is started for the first time on a new buffer, it
may prompt for confirmation of default or inferred settings, which you may
confirm or change interactively. 

You may also customize default settings globally by running appropriate
hooks or locally by inserting appropriate comments in the source file ---see
the manual below.

\subsection {Editing}

Once {\tt whizzytex-mode} is on, just type in as usual.  {\whizzy} should work
transparently, refreshing the presentation as you type or move into your
{\LaTeX} buffer. 

Additionally, a gray overlay is put outside of the current slice (the {\em
slice} is the region of your buffer under focus, which is automatically
determined by {\whizzy}). When a {\LaTeX} error occurs and it can be
localized in the source buffer, a yellow overlay also is put on the region
around the error, and removed when the error is fixed.

Furthermore, when an error is persistent for several slices or some amount
of time, the interaction-buffer will pop up with the error log
(this option can be toggled on and off with the {\tt Auto interaction} menu
entry).  

\subsection {Recovering from errors}

{\whizzy} makes a good attempt at doing everything automatically. 
However, there remains situations where the user need to understand 
{\whizzy} ---when {\whizzy} does not seem to understand the user anymore. 

For that purpose, {\whizzy} report processing and error messages
in its interaction window. Thus the first help for debugging
is always to look at interaction window (buffer 
\lst"*filename.tex*" (where \lst"filename" stands for the name of the file
associated with the main buffer in case several files are composing your
document). 

This window will pop up and down automatically when an error persists or
disappear. For debugging, you may switch this {\tt Auto interaction} mode
off so as to see the buffer permanently. You may also set the mark 
to prevent the region between \lst"(point-min)" and \lst"(mark)" to be
erased automatically (as long as the buffer is visible). 

The {\tt Log...} menu entry can be used to view log files of
last actions performed by whizzytex. 

\subsection {Error during initialization}

The most delicate part of {\whizzy} is when starting {\tt whizzytex-mode},
and usually for the first time in a new buffer, since at that time all kinds
of initialization errors may occur (in addition to {\LaTeX} errors. 

{\whizzy} will attempt to identify the error and report appropriate messages
in the interaction buffer. (In case an error occurs ---or nothing happens---
always have a look at the interaction buffer, even if it did not prompted
automatically.)

Here are a description of errors during initialization mostly in
chronological order. 

\paragraph {Emacs fails during setup}

This is all under emacs, so easily under control.
Normally, emacs should report error messages. See the documentation for
explanations. 

In case, of uncaught fatal errors, you may
\verb"Esc X toggle-debug-on-error" to get help from Emacs, and try to fix
the problem. 

\paragraph {Emacs cannot find whizzytex}

This should typically be an installation problem, where the variable
\lst"whizzytex-command-name" is erroneous (maybe you need to give the full
path). Try to evaluate \verb"(shell-command whizzytex-command-name)" in the
minibuffer, which of course should fail, but only after the command has been
reached.

\paragraph {Whizzytex cannot build a format}

Then {\whizzy} will refuse to start.  This is most probably an error in your
macros.  Try to compile {\LaTeX} your file.  
Also try to erase all auxiliary files, since if those are erroneous, they
may disturb the creation of the format (which loads some of the auxiliary
files). 

There still could be some bad interaction between your macros and {\whizzy}
macros, but this is very rare.

\paragraph {Whizzytex cannot launch the previewer}

Usually, this is because whizzytex received wrong previewer parameter.  See
the command echoed in the interaction buffer or try to evaluate
\lst"(whizzy-get whizzytex-view-mode)".

\paragraph {Other errors}

There are two remaining problems that could happen at launch time, but that
are not particular to launch time: {\whizzy} could not recompiled the whole 
document or the current slice. However, these should not be fatal. 
In the former case, whizzytex will proceed, ignoring the whole document 
(or using the slice instead if you are in duplex mode). In the later case,
whizzytex will replace the slice by an empty slice ---and print a welcoming
document, as if you lauch {\whizzy} outside of any slice. 

\subsection {Errors during normal edition}

After initialization time, {\whizzy} will keep recompiles slices as you
type or move, but also recompiles the format and the whole document when you
save a file. Each of this step may failed, but this should not be fatal, and
Emacs should report the error, possible pop up the interaction window, and
continue. 

\paragraph {Whizzytex fails on the current slice}

This should not be considered as an error, it {\bf must} happen during
edition. In particular, {\whizzy} is not much aware of {\LaTeX} and could
very well slice in the middle of the typesetting of an environment or a
macro command. This should not matter, since the erronesous slice will be
ignore temporarilly until the slice is correct again.

\paragraph {Whizzytex keeps failing on the current slice}

The slice can also be erroneous because the emacs did not correctly inferred
where to insert the cursor, which may slice erroenous, although what you
typed is correct. Hopefully, this will not occor too often, and disappear as
you move the point. It should also disappear if you swicth off both {\tt
Point visible} and {\tt Page to Point} options, which is actually a good
thing to do when you suspect some misbehavior.  This will make WhizzyTeX
more robust, but less powerful and more boring.

\paragraph {Whizzytex does not seem to slice at all}

The interaction window does not produce any output. 
Try to move in the slice, or to another slice. 

If nothing happens, check the interaction
window, to see if it did attempt to recompile the slice.
If nothing happens in the interaction window, check for emacs messages
(in the \lst"*Messages*" buffer). You may also check for the presence 
(and content) of the slice by visiting 
\lst"_whizzy_filename.tex" or
\begin{quote}
\begin{verbatim}
_whizzy_filename/input/_whizzy_name.new
\end{verbatim}
\end{quote}
If neither file exists, it means that emacs did
not succeed to slice, which you may force by evaluating
\lst"(whizzy-observe-changes t)". 
This can be run in even if {\tt whizzytex-mode} is suspended, which may
avoid automatic processing of slices, and their erasure.

If the slice is present, you may try to compile it by hand (outside of
emacs) with 
\begin{quote}
\begin{verbatim}
latex '&filename' _whizzy_filename.tex
\end{verbatim}
\end{quote}
and see if it succeeds. 


\paragraph {Reformatting failed}

Formatting errors are fatal during initialization, but accepted once
intialized. In case of an error during reformatting, {\whizzy} will ignore
the error and continue with the old format.  This means that new macros may
be ignored leading to further slicing errors. When rebuilding the format
failed, the mode-line string will display the suffix \lst"FMT" until the
error is fixed.  See the interaction buffer or select \lst"format" from the
\lst"log..." menu entry).

You may also force reformatting by typing the \lst"reformat" command
in the interaction buffer. 


\paragraph {Whizzytex cannot process the whole document}

This is very likely a problem with you document, so try to {\LaTeX} it 
first. There is a small possibility of strange interaction between
your macros and {\whizzy} package. Try to turn options 
{\tt Page to Point} and {\tt Point visible} off and retry. 
This will make {\whizzy} more robust (but also less powerful and more
boring). 


\section {\label{manual}Manual} 

This section describes how to use and
parameterize {\whizzy}. Most of it can also be found as Emacs online help:
\begin{quote}
\begin{verbatim}
ESC x describe-function RET whizzytex-mode
\end{verbatim}
\end{quote}
(Also available from the {\tt Help} entry of the {\tt Whizzy} menu of the Emacs
menu bar once in {\tt whizzytex-mode}.)  Then, you can really almost all
parts of the manual by following hyper-links. (In XEmacs, you may need to 
use 
\begin{quote}
\begin{verbatim}
ESC x hyper-describe-function RET whizzytex-mode
\end{verbatim}
\end{quote}
instead of \lst"describe-function" to see hyper-links.)


\subsection {Configuration} 

All parameters are assigned default values, so {\whizzy} should do something
reasonable on almost any {\LaTeX} file. However, only common classes have
been tried: book, article, seminar. 
Configuration can be done by setting emacs variables (for instance via a
whizzytex-mode-hook) or by setting file-dependent parameters by 
inserting configurations lines among the first lines of the file.

Turning the {\whizzy} mode on may ask the user to confirm or change the
default values if no local value has be specified 
(or if the user explicitly required to be asked
).


\subsubsection {Calling {\whizzy}}

The main command is \lst"whizzytex-mode" is used to activate or deactivate 
{\whizzy} mode. It takes one optional parameter. 

Without arguments it switches on and off the whizzytex-mode. With a negative
integer as argument it switches the mode off. With a strictly positive
integer argument, it attempts to turn the mode on.  This will examine the
file for local configuration parameters, or for guessing a best mode for the
file. If need be it will ask the user to confirm the default choices.

Furthermore, the \lst"0" and \lst"4" are recognized as special positive
arguments. In both cases, if the mode were already on, it will first be
switched off, and local configuration parameters will be reread, by
inspecting the file for local configuration parameters when the argument is
\lst"0", or by prompting the user so that it can confirm/change the current
values of configuration variables when the argument is \lst"4".

Emacs also offers several optional commands to move from slice to slice
(see \lst"whizzy-suggested-hook" in the \lst"whizzytex.el" file). 
There are also experimental commands for turning pages in the displayed
document. 


\subsubsection {File-based configuration}

A configuration line is matched by the regular expression:
\begin{quote}
\begin{verbatim}
   "^%; *\\(whizzy[^ \n]*\\) +\\([^\n]\\) *$"
\end{verbatim}%$
\end{quote}
and should appear in the first 400 bytes of the file. 

The first group is a configuration keyword. 
So far, the only-two  keywords are \lst"whizzy" and 
\lst"whizzy-paragraph". If two configuration
lines have the same keyword, only the first one is taken into
account.
\begin{description}
\item[whizzy]
This is the main configuration line and should match the following regular
expressions (otherwise, {\whizzy} will assigned default values to the
missing arguments): 
\begin{verbatim}
   "\\([^ \n]+\\) +\\([^ \n]+\\) +\\([^\n]*[^ \n]\\) *$"
\end{verbatim}%$
The first group determines the mode, {\i.e. em} the type of document, and
accordingly how it should be sliced.  The different modes are described in
section~\ref {modes}.

The second group defines the previewer type and are described in
section~\ref{types}.  The third group, called is the previewer parameter
whose semantics depends on the previewer type.

For instance, a typical configuration line will be:
\begin{verbatim}
   %; whizzy none -dvi xdvi
\end{verbatim}
tells whizzytex to be be launch in \lst"none" mode and use a \lst"dvi"
previewer called with the command \lst"xdvi"

More evolved configuration lines are:
\begin{verbatim}
   %; whizzy section -advi dview -whizzy -pre make -duplex
   %; whizzy section -advi "dview -whizzy" -pre make -duplex
\end{verbatim}
These two lines are equivalent, since emacs will remove outer quotes in
option arguments. They both tell whizzytex to be be launch in \lst"section"
mode and use a \lst"dvi" previewer called with the command 
\lst"dview -whizzy" 
(a shell-script to be defined), use \lst"make" to preprocess files
and provide \lst"duplex" views.

\item[whizzy-paragraph]
This sets the emacs-variable whizzy-paragraph to the \\
\lst"<args>" which should be a regular-expression string. 
\end{description} 


% \paragraph {File names} 
% The command will be passed the name of the target file
% \lst"_whizzy_$BASICFILENAME.tex", which it should produce from the source 
% file \lst"_whizzy_$BASICFILENAME.new" (the under which whizzy renames 
% the slice saved by emacs). 
% Here \lst"$BASICFILENAME" is the name of the file under \lst"WysiTeX"
% stripped off its suffix. By default, \lst"whizzy" will the source to
% the target. 
%$


\subsubsection {Emacs global configuration}

\label {emacs-configuration}

\paragraph {Emacs cool bindings}

The emacs mode defines the command \lst"whizzy-next-slice" and
\lst"whizzy-previous-slice", to move from slices forward or backward.
Binding these to appropriate keys will help you move pages from the emacs
buffer. 

These can be define using \lst"whizzytex-mode-hook". 
{\whizzy} does not do any default binding for you, since those are often
annoying when in conflict with personal bindings. 
However, it defines a function \lst"whizzy-suggested-hook", so that you can
get default bindings by adding the line
\begin{verbatim}
    (add-hook whizzytex-mode-hook 
        (function whizzy-suggested-hook))
\end{verbatim}
to your \lst".emacs" file. 
Then, you will get most useful binding (see only help). 
In particular, this will install a \lst"Whizzy" menu, from which you can
call for help.

Similarly, you can remove the other optional features, 
such as error-display that are on by default, by adding the line
\begin{verbatim}
    (add-hook whizzytex-mode-hook 
        (function whizzy-remove-options-hook)
\end{verbatim}
to your \lst".emacs" file.


\paragraph {Emacs configuration variables}

You can also change other configuration parameters globally by changing the
default values of whizzytex-mode emacs variables. 
Configurable variables are all listed at the beginning of the
\lst"whizzytex.el" file. You can change them directly, or using a 
the \lst"whizzytex-mode-hook". 


\subsection {Modes} 
\label {modes}

{\whizzy} recognizes three modes \lst"slide", \lst"section", and \lst"document". 
The mode determines the slice of the document being displayed and how
frequently updates occurs. 
\begin{description}

\item [slide]

The mode \lst"slide"  is mainly used for documents of the class seminar. 
In slide mode, the slide is the text between two \lst"\begin {slide}"
comments (thus,  the text between two slides is displayed after the
preceding slide).  

In slice modes, overlays are ignored {\em i.e.} all overlays all displayed in
the same slide, unless a command
\lst"\overlay {"$n$\lst"}" occurs on the left of the point, on the same line
(if several commands are on the same line, the 
right-most one is taken), in which case only layers $p \le n$ are displayed.

\item [section]
In \lst"section" mode, the slice of text is the current chapter, section.

\item [subsection]
As \lst"section" but also slice at subsections. 

\item [paragraph]
The \lst"paragraph" mode is a variation on section mode where, the separator
\lst"whizzy-paragraph" is defined by the user (set to two empty lines by
default) instead of using \lst"\section"  and \lst"\subsection" commands. 
subsection.

\item [document]
The \lst"document" take the region between \lst"\begin{document}"
and \lst"\end"\lst"{document}" as the slice. 

\item [none]
In \lst"none" slicing mode, there is no sectioning unit at all and
the whole document is recompiled altogether. 
Currently, pages are not turned to point and the 
cursor is not shown in \lst"document" mode, because full documents are not
sliced. (A slicing document mode could be obtained by working in paragraph
mode, with an appropriate regexp.)

\end{description}

\subsection {Previewer types}
\label {types}

The previewer types can have three possible values: 
\begin{description}
\item[{\bf  {\tt -ps}, {\tt -dvi}, or {\tt -advi}}]\indent

These indicate that file should be processed down to
\lst"Postscript" or  \lst"dvi" format respectively (\lst"-advi" 
mostly behaves as \lst"-dvi" but implies that the dvi previewers
recognizes extra \lst"\specials", such ass \lst"lines:".


Then, the previewer parameter is the
command to call 
the previewer.  This string will be passed as such to the {\whizzy}
shell-script. Note that the name of the \lst"dvi" or postscript file will be
appended to the previewer command.  Actually, other optional parameters to
the {\whizzy} shell-script can be added at the end of the previewer
parameter.  Arguments that contain blanks should be quoted (see \ref
{make}).  (For instance \lst"-pre <command>" can be used to define a
preprocessor to transform the slice into an input file for latex (\lst"cat"
is used by default).

\item[{\bf {\tt -master}}]\indent

This previewer type must be used when the file is not a {\LaTeX} document
but only a {\LaTeX} file included in a {\LaTeX} document. 
In this case, the third group is the name of the master file of the {\LaTeX}
document, {\em i.e.}, the one on which the \lst"latex" command can be run.

When a file is mastered, turning {\whizzy} mode on requires that another
buffer is already visiting the master file and that this buffer is in
{\whizzy} mode. Turning {\whizzy} mode off in a mastered file only affects
the local buffer and leaves {\whizzy} running on the master file. 

When the file is mastered, the document mode will only slice the current
file, not the entire {\LaTeX} document of the master file.

\end{description}

\subsection {Additional options}

Additionally parameters can be passed at the end command line

\begin{description}
\item[{\bf {\tt -pre MAKE}}]\indent
\label {make}

By default {\whizzy} take the slice as source latex code. 
That is the slice 
\lst"_whizzy_$BASENAME.new" saved by emacs is turned into the 
into the file \lst"_whizzy_$BASENAME.tex" to be be processed by latex,
using \lst"mv" as a preprocessor.  The above option will tell {\whizzy} to
use \lst"MAKE" instead of \lst"mv" to turn the slice into a latex source
file.

The command \lst"make" itself can be used as a preprocessor (with an
appropriate \lst"Makefile").  However, one may have to work around
\lst"make"'s notion of time, which is usually too rough. 
This is safe, since
{\whizzy} tests itself for needed recompilations: it does so by dropping any
new version in a  special directory (\lst"_whizzy_$BASENAME/input/"), 
%$
called the {\em pool}.

\item[{\bf {\tt -duplex}}]\indent
\label {dupplex}

This option tells whizzytex to launch two previewers, one to the slice and
one to the whole document (which is recompiled every time the source buffer
is saved).

This option is particularly useful with \lst"-advi" previewers, since both
views can then communicate with emacs and not just the view on the slice.

\item[{\bf {\tt -fmt FORMAT}}]\indent

By default {\whizzy} build a specialized format of the \lst"latex" document
format by loading macros of your document.  The above option will use
\lst"FORMAT" instead of \lst"latex" as the initial format. For instance,
\lst"hugelatex" could be used (depending on your {\LaTeX} configuration) to
build a larger format to process huge files.

\end{description}



\subsection {Watching other files}

{\whizzy} is designed to watch other files than just the slice saved by
emacs. In fact, it watches any file dropped in the pool directory. 
For instance, 
if your source file uses images, you can just change the image and
drop the new version in the pool. Then {\whizzy} will pick the new version,
move it to the working directory and recompile a new slice. Be aware of name
clashes: if you drop a file in the pool, it will automatically be move to
the working directory with the same name, overriding any file of the same
name sitting there. 

By default, {\whizzy} send itself a \lst"kill -STOP" signal when it finds
nothing in the pool (this allows you to let {\whizzy} inactive for hours
without consuming any CPU. Correspondingly, when emacs drops a new file in
the pool, it sends a \lst"kill -CONT" signal. If you want to watch other
files and not have to deal with waking up {\whizzy} you can pass the extra
option \lst"-nonstop" to the \lst"whizzytex" command-line; then it will sleep
instead of stopping itself, and will periodically watch for news files 
in the pool without you need to signal it to continue. 
In case you want to keep with the stop-mode and wake it up explicitly, the
process number is stored in the file \lst"._whizzy_$BASICNAME.tex". %$

\subsection {Frequency of recompilation} 

To obtain maximum {\whizzy} effect, a new slice should be save after any
edition changed or any displacement that outside of the current slice.
However, to avoid overloading the machine with useless and annoying
refreshments, some compromise is made: when either edition or movement
is continuous, saving a new slice is delayed until at least 10 editing
changes. The continuity is controlled in milliseconds by the emacs variable
\lst"whizzy-pause". This variable is set to \lst"200" in slide
mode, to \lst"1000" in section mode, and to \lst"2000" in document mode.

The format is automatically recompiled at the beginning of each session, and
whenever the buffer containing the file is saved. That is, to load new
packages or define new global macros (before the \lst"\begin{document}"), it
suffices to save the current file.

\subsection {Cross-references, page and section numbers} 

The slice is always recompiled with the \lst".aux" file of the whole
document.  In paragraph mode, cross references and section numbers are 
recompiled whenever the buffer itself is saved (manually). 
This recompilation operates in batch and concurrently with the recompilation
of slices, so it may take several slices before the new counters or
references are adjusted.

(The recompilation of the whole document is off in slide mode.) 


\section {Previewing with Active-Dvi}

Active-Dvi is a DVI previewer with several additional features.
In particular, it recognizes extra specials, some of which are particular 
useful for whizzytex that allows a two way communication between 
the source emacs buffer and the previewer: 
\begin {itemize}
\item
The previewer will automatically turn pages for you, as you are editing. 
This is done by telling emacs to save the current position in the slice. 
Then, the recompilation of the slice will include the current position 
as an hyperref location \lst"Start-Document" whenever possible. 
Then, just tell \lst"Active-Dvi" to automatically jump at this location
when it opens/reloads the file. 

\item
Conversely, \lst"Active-Dvi" can dump source file positions on clicks, 
when available, that is forwarded to emacs so that it can move to the
corresponding line.

To enjoy this feature, the option \lst"-advi" should be used instead of
\lst"-dvi". This will produce extra information (such as source line
numbers) using \lst"\specials" that more DVI previewers do not recognize
and may complain about.


\end {itemize}
Hence, my emacs setup executes
{\small
\begin{verbatim}
(add-hook
  'whizzytex-mode-hook 
  '(lambda ()
     (set-default 'whizzy-view "-advi \"dview -html Start-Document\"")))
\end{verbatim}}

\section {Implementation}

In short, {\sc \whizzy} is selecting a small slice of the document that 
you are editing around the cursor (according to the selected mode) 
and redisplay the slice incrementally as it changes through edition. 
\begin {itemize}

\item {\bf Emacs is watching you} typing and moving in the 
emacs buffer attached to the {\TeX} source file that your editing and keeps
saving the current slice (current slide, section, or subsection, according
to the mode).

\item {\bf A shell-script deamon}
keeps recompiling whenever a new slice (or other files) are procuced, and if
recompilation succeeds, tels the previewer to updates the display of the slice.

\item {\bf A few {\LaTeX} macros} allow to build a specialized
format with all macro loaded, which considerably speed up the time for
slicing. Additionally, the slice is a bit instrumented to show the cursor,
and includes specials that allows back-pointing from the DVI file into the
emacs buffer.

\end {itemize}
The rest of this section briefly describe these three parts\footnote {This
section is not quite up-to-date, hence it puts emphasis on the original
design, but several aspects have changed significantly since the first
version. Implementation of more recent features is thus ommitted.}, and
their interactions.


\subsection {Emacs code}

Besides administrative business, the main trick is to use 
\lst"post-command-hook" to make emacs watch changes. 
It uses \lst"buffer-modified-tick" to tell if any editing has actually
occurred, and compare the point position with the (remembered) position of
the region being displayed to see if saving should occur. It also uses
\lst"sit-for" to delay savings until idleness or a 
significant number of editing changes. 

{\whizzy} can also show the current point on the display, in which case
slices are also recomputed when the cursor moves, but with lower priority.

\subsection {TeX code}

The main TeX hack is to build a format file so as to avoid reloading the
whole macros at each compilation. This is (almost\footnote{{\tt
$\backslash$begin\{document\}} should be typed as such without any white
white space}) entirely transparent, that is, the source file does not have
to understand this.

The hack is to redefine \lst"\documentclass" which in turn  redefines
\lst"\document" to execute \lst"\dump" (after redefining \lst"\document"
to its old value and \lst"\documentclass" so that it skips everything till
\lst"\document"). This is rather robust ---it even works with 
complex macros such as my preferred package \lst"localmacros" that reads
macros at the end of the document.

There are a few other less important hacks. For instance, the following
macros are also made available (but only for expert use):
\begin {itemize}
\item
\lst"\WizzytexInput" is used by the shell-script to tell {\TeX} to dump page
and section  numbers in some format that is later processed by Unix to be
passed back to emacs as emacs-lisp code.
\item
\lst"\WizzySlice" is used by emacs to tell {\TeX} to adjust counters to
the current section. 
\item
\lst"\WhizzyLine" is used by emacs to tell where the cursor is.
Then \TeX\ will display the cursor if possible, {\em i.e.} if the cursor is
not in a special mode. This usually works fine, but may sometimes interfere
with the output. 
\end {itemize}
When compiling the format, {\whizzy} also look for a file of name
\lst"whizzy.sty", which if existing is loaded at the end of the macros. 
This may be used to add other macros in {whizzy} mode, {\em e.g.} 
some {\TeX} environments may be redefined to changed they type setting,
according to whether the current line is inside or outside the environment. 
(We have written such an extension for an exercise package that sends the
answers at the end in an appendix, unless the cursor is inside the answer,
in which case the answer is in-lined.)

\subsection {Bash code}

Mainly, a Unix shell-script is watching the spooler file.  It recompiles the
format file (and the page and section number, but in batch mode) whenever
the source file (its Unix date) has changed  and 
recompiles the slice whenever it is present (since {\whizzy} renames ---hence
removes--- the slice before processing it).

If the file has been recompiled successfully, it triggers the previewer
(ghostscript or xdvi) so that it rereads the dvi or ps file. Otherwise, it
processes the {\TeX} log file and tries to locate the error. It then sends part
of the log file with annotations to the \lst"*TeX-shell*" buffer from which
emacs has been {\whizzy}, so that emacs can report the error. 


\subsection {Cool hacks}

Cursor, back-pointing, line and file numbers.


\subsection {Dirty hacks}

{\LaTeX} macros are somewhat hacky, but what else could one expect?
Actually, the package has been written with many comments and in a modular
way so that it should be almost easy  to modify\ldots{} for a {\TeX} expert.
Some in some sense, for the non expert \lst"whizzytex.sty" is full of dirty
hacks. 

{\whizzy} works best with the \lst"advi" previewer, as explained above. 
However, it also works with \lst"xdvi" and \lst"gv". 

Sending the signal \lst"-HUP" to \lst"gv" should make it reopen the file.
However, \lst"gv" does not execute the update if the newer version has the
same time stamp as the older version. Fortunately, it executes the reopen if
the new version has a modified time older than the old version :-) Here the
output Postscript file  is also annotated, when necessary, to force \lst"gv"
to reopen it.


\subsection {Interaction between the components} 

The control is normally done by emacs, which launches and kill the Unix
daemon. However, for robustness, the Unix daemon will commit suicide if the
previewer is dead, and in turn, the {\whizzy} mode will automatically turn
itself off when it notices that daemon has died. This allows to turn off
the {\whizzy} mode, simply by exiting the previewer.

To that purpose, the daemon pid is saved in a file. 
This is also used to prevent several daemon running on the same file. 
Then {\whizzy} must be called with \lst"-kill" option to cleanup an  old
running session, which is done automatically when the mode is turn off.


\end{document}

- Clicks

- Say that cursor does not always appear.
% LocalWords:  whizzy advi html whizzytex HeVeA BGCOLOR Didier INRIA ee ou ing
% LocalWords:  ghostview xdvi DVI xemacs Redhat tgz untar gunzip xf usr config
% LocalWords:  Esc tex minibuffer FMT online dvi dview args autoload ps pre mv
% LocalWords:  BASENAME hyperref gv HUP pid
